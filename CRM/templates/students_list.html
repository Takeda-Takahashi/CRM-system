{% extends 'header_menu.html' %}
{% load static %}

{% block title %}CRM — Ученики{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/students_style.css' %}">
<style>
/* Исправляем цвета для текста */
    .student-name {
        color: #2c3e50 !important; /* Темно-синий для имени */
        font-weight: 700;
    }

    .student-birthdate {
        color: #95a5a6 !important; /* Серый для даты рождения */
    }

    /* Исправляем цвета для статусов */
    .active-badge {
        color: #388e3c !important; /* Зеленый для активного */
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9) !important;
    }

    .inactive-badge {
        color: #616161 !important; /* Серый для неактивного */
        background: linear-gradient(135deg, #f5f5f5, #e0e0e0) !important;
    }

    /* Исправляем цвет ссылок в таблице */
    .phone-cell a, .email-cell a {
        color: #2c3e50 !important; /* Темно-синий для ссылок */
    }

    .phone-cell a:hover, .email-cell a:hover {
        color: #3498db !important; /* Голубой при наведении */
    }

    /* Убираем белый фон при наведении на строку */
    .student-row:hover {
        background-color: #f8fbff !important; /* Очень светло-голубой */
    }

    /* Исправляем цвет даты регистрации */
    .date-cell {
        color: #2c3e50 !important; /* Темно-синий */
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <h1><i class="fas fa-users"></i> Список учеников</h1>
        <div class="header-actions">
            <a href="/admin/core/participants/add/" class="btn btn-primary" style="
                padding: 12px 24px;
                background: linear-gradient(135deg, #3498db, #2980b9);
                border: none;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                text-decoration: none;
                display: flex;
                align-items: center;
                gap: 10px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            ">
                <i class="fas fa-plus"></i> Добавить ученика
            </a>
        </div>
    </div>

    <!-- Таблица учеников -->
    <div class="students-table-container">
        <table class="students-table">
            <thead>
                <tr>
                    <th>Ученик</th>
                    <th>Телефон</th>
                    <th>Email</th>
                    <th>Статус</th>
                    <th>Дата регистрации</th>
                    <th style="text-align: center;">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr class="student-row"
                    data-student-id="{{ student.id }}"
                    onclick="openStudentCard({{ student.id }})">
                    <td>
                        <div class="student-info-cell">
                            <div class="student-avatar">
                                {{ student.first_name|first }}{{ student.last_name|first }}
                            </div>
                            <div class="student-name-container">
                                <div class="student-name">
                                    {{ student.last_name }} {{ student.first_name }}
                                </div>
                                <div class="student-details">
                                    <span class="student-birthdate">
                                        {{ student.birth_date|date:"d.m.Y" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if student.phone %}
                        <div class="phone-cell">
                            <i class="fas fa-phone"></i>
                            <a href="tel:{{ student.phone }}" onclick="event.stopPropagation();">
                                {{ student.phone }}
                            </a>
                        </div>
                        {% else %}
                        <span style="color: #95a5a6; font-style: italic;">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if student.email %}
                        <div class="email-cell">
                            <i class="fas fa-envelope"></i>
                            <a href="mailto:{{ student.email }}" onclick="event.stopPropagation();">
                                {{ student.email }}
                            </a>
                        </div>
                        {% else %}
                        <span style="color: #95a5a6; font-style: italic;">—</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge {% if student.is_active %}active-badge{% else %}inactive-badge{% endif %}">
                            {% if student.is_active %}Активный{% else %}Неактивный{% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="date-cell">
                            <i class="fas fa-calendar"></i>
                            {{ student.join_date|date:"d.m.Y" }}
                        </div>
                    </td>
                    <td onclick="event.stopPropagation();">
                        <div class="quick-actions">
                            <button class="btn-action btn-card"
                                    onclick="openStudentCard({{ student.id }})"
                                    title="Карточка ученика">
                                <i class="fas fa-id-card"></i>
                            </button>
                            <button class="btn-action btn-edit"
                                    onclick="window.location.href='/admin/core/participants/{{ student.id }}/change/'"
                                    title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete"
                                    onclick="deleteStudent(event, {{ student.id }}, '{{ student.first_name }}', '{{ student.last_name }}')"
                                    title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="no-data-row">
                        <div class="empty-state">
                            <i class="fas fa-user-slash"></i>
                            <h3>Нет учеников</h3>
                            <p>Добавьте первого ученика в систему</p>
                            <a href="/admin/core/participants/add/" class="btn btn-primary" style="
                                padding: 12px 24px;
                                background: linear-gradient(135deg, #3498db, #2980b9);
                                border: none;
                                border-radius: 8px;
                                color: white;
                                font-weight: 600;
                                text-decoration: none;
                                display: inline-flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <i class="fas fa-plus"></i> Добавить ученика
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Пагинация -->
        {% if students.has_other_pages %}
        <div class="pagination">
            {% if students.has_previous %}
            <a href="?page={{ students.previous_page_number }}">
                <i class="fas fa-chevron-left"></i> Назад
            </a>
            {% endif %}

            <span class="current">
                Страница {{ students.number }} из {{ students.paginator.num_pages }}
            </span>

            {% if students.has_next %}
            <a href="?page={{ students.next_page_number }}">
                Вперед <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
// Функция для получения CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Функция для открытия карточки ученика
function openStudentCard(studentId) {
    console.log('Открываем карточку ученика ID:', studentId);
    window.location.href = `/students/${studentId}/`;
}

// Функция для удаления ученика
function deleteStudent(event, studentId, firstName, lastName) {
    event.stopPropagation();

    if (confirm(`Удалить ученика ${firstName} ${lastName}?`)) {
        fetch(`/api/participants/${studentId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Ошибка при удалении');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении');
        });
    }
}

// Улучшенная обработка кликов по строкам
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.student-row');

    rows.forEach(row => {
        // Добавляем красивый эффект при наведении
        row.addEventListener('mouseenter', function() {
            this.style.transition = 'all 0.3s ease';
        });

        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });

        // Обработка клика по всей строке
        row.addEventListener('click', function(e) {
            // Если клик был по кнопке или ссылке - не переходим
            if (e.target.closest('button') || e.target.closest('a')) {
                return;
            }

            const studentId = this.getAttribute('data-student-id');
            if (studentId) {
                openStudentCard(studentId);
            }
        });
    });

    // Добавляем стиль для кнопки карточки
    const style = document.createElement('style');
    style.textContent = `
        .btn-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1976d2;
        }
        .btn-card:hover {
            background: #bbdefb;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}