{% extends 'header_menu.html' %}
{% load static %}
{% load humanize %}  {# для форматирования чисел #}

{% block title %}CRM — {{ student.full_name }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/students_card_style.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <!-- Шапка с кнопками -->
        <div class="header">
            <h1><i class="fas fa-user-graduate"></i> Карточка ученика</h1>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="alert('Функция редактирования в разработке')">
                    <i class="fas fa-edit"></i> Редактировать
                </button>
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Распечатать
                </button>
                <button class="btn btn-primary" onclick="sendEmail('{{ student.email }}')">
                    <i class="fas fa-envelope"></i> Отправить
                </button>
            </div>
        </div>

        <!-- Основная карточка ученика -->
        <div class="student-card">
            <!-- Левая часть - фото и основное -->
            <div class="student-left">
                <div class="avatar-container">
                    {% if student.photo %}
                        <img src="{{ student.photo.url }}" alt="Фото ученика" class="avatar">
                    {% else %}
                        <img src="{% static 'images/default_avatar.png' %}" alt="Фото ученика" class="avatar">
                    {% endif %}
                    <div class="avatar-edit" onclick="changePhoto({{ student.id }})">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>

                <div class="student-name">{{ student.last_name }} {{ student.first_name }} {{ student.middle_name|default:"" }}</div>
                <div class="student-id">ID: {{ student.student_id|default:"STU-"|add:student.id }}</div>

                <div class="status-badge status-{{ student.status|lower }}">
                    {% if student.status == 'active' %}
                        <i class="fas fa-check-circle"></i> Активный
                    {% elif student.status == 'inactive' %}
                        <i class="fas fa-pause-circle"></i> Неактивный
                    {% elif student.status == 'frozen' %}
                        <i class="fas fa-snowflake"></i> Заморожен
                    {% endif %}
                </div>

                <div class="quick-info">
                    {% if student.birth_date %}
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Возраст: {{ age }} лет</span>
                        </div>
                    {% endif %}

                    <div class="info-item">
                        <i class="fas fa-phone"></i>
                        <span>{{ student.phone|default:"Телефон не указан" }}</span>
                    </div>

                    <div class="info-item">
                        <i class="fas fa-envelope"></i>
                        <span>{{ student.email|default:"Email не указан" }}</span>
                    </div>

                    {% if student.city %}
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ student.city }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Правая часть -->
            <div class="student-right">
                <!-- ВЕРХНЯЯ ЧАСТЬ: Горизонтальная группировка информации -->
                <div class="student-info-horizontal">
                    <!-- Личная информация -->
                    <div class="info-section">
                        <h3><i class="fas fa-user"></i> Личная информация</h3>
                        {% if student.birth_date %}
                        <div class="info-row">
                            <span class="info-label">Дата рождения:</span>
                            <span class="info-value">{{ student.birth_date|date:"d.m.Y" }}</span>
                        </div>
                        {% endif %}

                        {% if student.gender %}
                        <div class="info-row">
                            <span class="info-label">Пол:</span>
                            <span class="info-value">{{ student.get_gender_display }}</span>
                        </div>
                        {% endif %}

                        <div class="info-row">
                            <span class="info-label">Дата регистрации:</span>
                            <span class="info-value">{{ student.created_at|date:"d.m.Y" }}</span>
                        </div>

                        {% if student.source %}
                        <div class="info-row">
                            <span class="info-label">Источник:</span>
                            <span class="info-value">{{ student.get_source_display }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Контактная информация -->
                    <div class="info-section">
                        <h3><i class="fas fa-address-book"></i> Контакты</h3>
                        <div class="info-row">
                            <span class="info-label">Телефон:</span>
                            <span class="info-value">{{ student.phone|default:"Не указан" }}</span>

                        </div>

                        {% if student.emergency_contact %}
                        <div class="info-row">
                            <span class="info-label">Экстренный контакт:</span>
                            <span class="info-value">{{ student.emergency_contact }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Экстренный телефон:</span>
                            <span class="info-value">{{ student.emergency_phone }}</span>
                        </div>
                        {% endif %}


                        {% if student.address %}
                        <div class="info-row">
                            <span class="info-label">Адрес:</span>
                            <span class="info-value">{{ student.address }}</span>
                        </div>
                        {% endif %}

                        {% if student.parents_info %}
                        <div class="info-row">
                            <span class="info-label">Родители:</span>
                            <span class="info-value">{{ student.parents_info|truncatechars:30 }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Дополнительная информация -->
                    <div class="info-section">
                        <h3><i class="fas fa-info-circle"></i> Дополнительно</h3>
                        {% if student.level %}
                        <div class="info-row">
                            <span class="info-label">Уровень:</span>
                            <span class="info-value">{{ student.get_level_display }}</span>
                        </div>
                        {% endif %}

                        {% if student.coach %}
                        <div class="info-row">
                            <span class="info-label">Тренер:</span>
                            <span class="info-value">{{ student.coach.full_name }}</span>
                        </div>
                        {% endif %}

                        <div class="info-row">
                            <span class="info-label">Статус:</span>
                            <span class="info-value">{{ student.get_status_display }}</span>
                        </div>

                        {% if student.notes %}
                        <div class="info-row">
                            <span class="info-label">Заметки:</span>
                            <span class="info-value">{{ student.notes|truncatechars:30 }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- НИЖНЯЯ ЧАСТЬ: Абонементы и платежи -->
                <div class="student-full-width-container">
                    <div class="full-width-header">
                        <h3><i class="fas fa-credit-card"></i> Абонементы и платежи</h3>
                    </div>

                    <div class="full-width-content">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">{{ active_subscriptions_count }}</div>
                                <div class="stat-label">Активных абонемента</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ total_cost|intcomma }} ₽</div>
                                <div class="stat-label">Общая стоимость</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ student.attendance_percentage|default:"0" }}%</div>
                                <div class="stat-label">Посещаемость</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ total_lessons }}</div>
                                <div class="stat-label">Всего занятий</div>
                            </div>
                        </div>

                        <!-- Абонементы по видам оружия -->
                        <div class="weapon-subscriptions-section">
                            <div class="weapons-header">
                                <h4><i class="fas fa-swords"></i> Абонементы по направлениям</h4>
                                <button class="btn btn-primary btn-small" onclick="addSubscription({{ student.id }})">
                                    <i class="fas fa-plus"></i> Добавить абонемент
                                </button>
                            </div>

                            <div class="weapons-grid">
                                {% for subscription in subscriptions %}
                                <div class="weapon-card" data-weapon="{{ subscription.weapon_type }}"
                                     onmouseover="showWeaponDetails('{{ subscription.id }}')"
                                     onmouseout="hideWeaponDetails('{{ subscription.id }}')">
                                    <div class="weapon-icon">
                                        {% if subscription.weapon_type == 'rapier' %}
                                            <i class="fas fa-bolt"></i>
                                        {% elif subscription.weapon_type == 'epee' %}
                                            <i class="fas fa-shield-alt"></i>
                                        {% elif subscription.weapon_type == 'sabre' %}
                                            <i class="fas fa-cut"></i>
                                        {% else %}
                                            <i class="fas fa-crosshairs"></i>
                                        {% endif %}
                                    </div>
                                    <div class="weapon-info">
                                        <h5 class="weapon-name">{{ subscription.get_weapon_type_display }}</h5>
                                        <div class="weapon-status {{ subscription.status }}">
                                            {% if subscription.status == 'active' %}
                                                <i class="fas fa-check-circle"></i> Активен
                                            {% elif subscription.status == 'pending' %}
                                                <i class="fas fa-clock"></i> Ожидает оплаты
                                            {% elif subscription.status == 'expired' %}
                                                <i class="fas fa-times-circle"></i> Завершен
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="weapon-details" id="details-{{ subscription.id }}">
                                        <div class="detail-item">
                                            <span class="detail-label">Осталось занятий:</span>
                                            <span class="detail-value">{{ subscription.remaining_lessons }} из {{ subscription.total_lessons }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Действует до:</span>
                                            <span class="detail-value">{{ subscription.end_date|date:"d.m.Y"|default:"Не указано" }}</span>
                                        </div>
                                        {% if subscription.coach %}
                                        <div class="detail-item">
                                            <span class="detail-label">Тренер:</span>
                                            <span class="detail-value">{{ subscription.coach.full_name }}</span>
                                        </div>
                                        {% endif %}
                                        <button class="btn-weapon-action" onclick="viewSubscription({{ subscription.id }})">
                                            <i class="fas fa-chart-line"></i> Подробнее
                                        </button>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="empty-state">
                                    <i class="fas fa-inbox" style="font-size: 48px; color: #bdc3c7; margin-bottom: 15px;"></i>
                                    <p style="color: #7f8c8d;">У ученика нет абонементов</p>
                                    <button class="btn btn-primary" onclick="addSubscription({{ student.id }})">
                                        <i class="fas fa-plus"></i> Добавить первый абонемент
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Нижнее меню с вкладками -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="payments">
                    <i class="fas fa-money-bill-wave"></i> Оплаты
                    <span class="tab-count">{{ payments.count }}</span>
                </button>
                <button class="tab-btn" data-tab="groups">
                    <i class="fas fa-users"></i> Группы
                    <span class="tab-count">{{ groups.count }}</span>
                </button>
                <button class="tab-btn" data-tab="lockers">
                    <i class="fas fa-lock"></i> Шкафчики
                    <span class="tab-count">1</span>
                </button>
                <button class="tab-btn" data-tab="attendance">
                    <i class="fas fa-calendar-check"></i> Посещаемость
                </button>
                <button class="tab-btn" data-tab="progress">
                    <i class="fas fa-chart-line"></i> Прогресс
                </button>
                <button class="tab-btn" data-tab="notes">
                    <i class="fas fa-sticky-note"></i> Заметки
                    <span class="tab-count">{{ notes.count }}</span>
                </button>
            </div>

            <div class="tab-content">
                <!-- Вкладка оплат -->
                <div class="tab-pane active" id="payments">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #2c3e50;">История платежей</h3>
                        <button class="btn btn-primary btn-small" onclick="addPayment({{ student.id }})">
                            <i class="fas fa-plus"></i> Добавить платеж
                        </button>
                    </div>

                    {% if payments %}
                    <div class="payments-grid">
                        {% for payment in payments %}
                        <div class="payment-card {% if payment.status == 'overdue' %}overdue{% endif %}">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <strong style="color: #2c3e50;">{{ payment.get_month_display }} {{ payment.date.year }}</strong>
                                <span style="color: {% if payment.status == 'paid' %}#2ecc71{% else %}#e74c3c{% endif %}; font-weight: 600;">
                                    {{ payment.amount|intcomma }} ₽
                                </span>
                            </div>
                            <div style="color: #7f8c8d; font-size: 14px; margin-bottom: 10px;">
                                {% if payment.status == 'paid' %}
                                    Оплачено {{ payment.date|date:"d.m.Y" }}
                                {% elif payment.status == 'overdue' %}
                                    Просрочено с {{ payment.due_date|date:"d.m.Y" }}
                                {% else %}
                                    Ожидает оплаты до {{ payment.due_date|date:"d.m.Y" }}
                                {% endif %}
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <span style="background: {% if payment.status == 'paid' %}#e8f6f3{% else %}#ffebee{% endif %};
                                      color: {% if payment.status == 'paid' %}#27ae60{% else %}#c62828{% endif %};
                                      padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                    {{ payment.get_payment_method_display }}
                                </span>
                                {% if payment.is_autopayment %}
                                <span style="background: #e8f6f3; color: #27ae60; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                    Автоплатеж
                                </span>
                                {% endif %}
                                {% if payment.subscription %}
                                <span style="background: #e8f4fd; color: #3498db; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                    {{ payment.subscription.get_weapon_type_display }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-money-bill-wave" style="font-size: 48px; color: #bdc3c7; margin-bottom: 15px;"></i>
                        <p style="color: #7f8c8d;">Нет данных о платежах</p>
                        <button class="btn btn-primary" onclick="addPayment({{ student.id }})">
                            <i class="fas fa-plus"></i> Добавить первый платеж
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Вкладка групп -->
                <div class="tab-pane" id="groups">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #2c3e50;">Текущие группы</h3>
                        <button class="btn btn-primary btn-small" onclick="addToGroup({{ student.id }})">
                            <i class="fas fa-plus"></i> Добавить в группу
                        </button>
                    </div>

                    {% if groups %}
                    <div class="groups-grid">
                        {% for group in groups %}
                        <div class="group-card">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <div style="width: 40px; height: 40px; background: {{ group.color|default:'#3498db' }};
                                     border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                    <i class="fas {{ group.icon|default:'fa-users' }}"></i>
                                </div>
                                <div>
                                    <strong style="color: #2c3e50;">{{ group.name }}</strong>
                                    <div style="color: #7f8c8d; font-size: 14px;">{{ group.schedule }}</div>
                                </div>
                            </div>
                            <div style="color: #7f8c8d; font-size: 14px; margin-bottom: 15px;">
                                Тренер: {{ group.coach.full_name|default:"Не назначен" }}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="background: #e8f4fd; color: #3498db; padding: 5px 12px; border-radius: 15px; font-size: 12px;">
                                    {{ group.students_count }} учеников
                                </span>
                                <span style="color:
                                    {% if group.status == 'active' %}#2ecc71
                                    {% elif group.status == 'full' %}#f39c12
                                    {% else %}#95a5a6{% endif %};
                                    font-weight: 600;">
                                    {{ group.get_status_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-users" style="font-size: 48px; color: #bdc3c7; margin-bottom: 15px;"></i>
                        <p style="color: #7f8c8d;">Ученик не состоит в группах</p>
                        <button class="btn btn-primary" onclick="addToGroup({{ student.id }})">
                            <i class="fas fa-plus"></i> Добавить в группу
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Вкладка шкафчиков -->
                {% if locker %}
                <div class="tab-pane" id="lockers">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Арендованные шкафчики</h3>
                    <div class="lockers-grid">
                        <div class="locker-card">
                            <i class="fas fa-lock" style="font-size: 40px; color: #3498db;"></i>
                            <div class="locker-number">{{ locker.number }}</div>  <!-- locker - это объект Lockers -->
                            <div style="color: #7f8c8d; margin-bottom: 15px;">
                                Зона: {{ locker.zone|default:"Основной зал" }}
                            </div>

                            <!-- Информация об аренде -->
                            <div style="margin-bottom: 10px;">
                                <div style="color: #2c3e50; font-weight: 600;">Начало аренды: {{ locker_rental.start_date|date:"d.m.Y" }}</div>
                            </div>

                            <div style="margin-bottom: 10px;">
                                <div style="align-self: center; color: #2c3e50; font-weight: 600; display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
                                    <span>Конец аренды:</span>
                                    <span style="color: {% if locker_rental.status == 'active' %}#27ae60{% else %}#e74c3c{% endif %};">
                                        {{ locker_rental.actual_end_date|date:"d.m.Y"|default:"Не указано" }}
                                    </span>
                                    {% if locker_rental.status != 'active' %}
                                    <span style="color: #e74c3c; font-size: 12px;">
                                        ({{ locker_rental.status|default:"Истекла" }})
                                    </span>
                                    {% endif %}
                                </div>
                            </div>

                            <div style="margin-bottom: 10px;">
                                <div style="color: #2c3e50; font-weight: 600;">Стоимость аренды: {{ locker_rental.rental_cost }} ₽</div>
                            </div>

                            {% if locker_rental.payment_period %}
                            <div style="margin-bottom: 10px;">
                                <div style="color: #2c3e50; font-weight: 600;">Период оплаты: {{ locker_rental.payment_period }}</div>
                            </div>
                            {% endif %}

                            <div style="margin-bottom: 15px;">
                                <div style="color: #2c3e50; font-weight: 600;">Ключ:
                                    {% if locker_rental.key_issued %}
                                        <span style="color: #27ae60;">Выдан {{ locker_rental.key_issue_date|date:"d.m.Y"|default:"" }}</span>
                                    {% else %}
                                        <span style="color: #e74c3c;">Не выдан</span>
                                    {% endif %}
                                </div>
                            </div>

                            <button style="background: #3498db; color: white; border: none; padding: 10px 20px;
                                    border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 10px;"
                                    onclick="extendLocker({{ locker_rental.id }})">
                                {% if locker_rental.status == 'active' %}Продлить аренду{% else %}Арендовать снова{% endif %}
                            </button>

                            <button style="background: {% if locker_rental.key_issued %}#e74c3c{% else %}#2ecc71{% endif %};
                                    color: white; border: none; padding: 10px 20px;
                                    border-radius: 8px; cursor: pointer; width: 100%;"
                                    onclick="manageKey({{ locker_rental.id }}, {{ locker_rental.key_issued|yesno:'true,false' }})">
                                {% if locker_rental.key_issued %}Сдать ключ{% else %}Выдать ключ{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Вкладка посещаемости -->
                <div class="tab-pane" id="attendance">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Статистика посещаемости</h3>
                    <div class="attendance-chart">
                        {% if student.attendance_data %}
                        <!-- Здесь можно добавить график с Chart.js -->
                        <canvas id="attendanceChart" width="400" height="200"></canvas>
                        {% else %}
                        <div style="text-align: center;">
                            <i class="fas fa-chart-pie" style="font-size: 60px; color: #3498db; margin-bottom: 20px;"></i>
                            <div>Нет данных для отображения</div>
                            <div style="font-size: 14px; margin-top: 10px;">
                                Общая посещаемость: {{ student.attendance_percentage|default:"0" }}%
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Вкладка прогресса -->
                <div class="tab-pane" id="progress">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Прогресс обучения</h3>
                    <div class="attendance-chart">
                        {% if student.progress_data %}
                        <!-- Здесь можно добавить график прогресса -->
                        <canvas id="progressChart" width="400" height="200"></canvas>
                        {% else %}
                        <div style="text-align: center;">
                            <i class="fas fa-chart-line" style="font-size: 60px; color: #2ecc71; margin-bottom: 20px;"></i>
                            <div>Нет данных о прогрессе</div>
                            <div style="font-size: 14px; margin-top: 10px;">
                                {% if student.last_rating %}
                                Последняя оценка тренера: {{ student.last_rating }}/10
                                {% else %}
                                Оценки тренера отсутствуют
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Вкладка заметок -->
                <div class="tab-pane" id="notes">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #2c3e50;">Заметки тренера</h3>
                        <button class="btn btn-primary btn-small" onclick="addNote({{ student.id }})">
                            <i class="fas fa-plus"></i> Добавить заметку
                        </button>
                    </div>

                    {% if notes %}
                        {% for note in notes %}
                        <div style="background: white; padding: 25px; border-radius: 12px;
                             box-shadow: 0 3px 10px rgba(0,0,0,0.08); margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <strong style="color: #2c3e50;">{{ note.date|date:"d.m.Y H:i" }}</strong>
                                <span style="color: #7f8c8d; font-size: 14px;">
                                    {% if note.author %}
                                    Тренер: {{ note.author.full_name }}
                                    {% else %}
                                    Система
                                    {% endif %}
                                </span>
                            </div>
                            <p style="color: #34495e; line-height: 1.6; white-space: pre-wrap;">{{ note.content }}</p>

                            {% if note.tags %}
                            <div style="display: flex; gap: 5px; margin-top: 15px; flex-wrap: wrap;">
                                {% for tag in note.get_tags_list %}
                                <span style="background: #f0f0f0; color: #555; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                    {{ tag }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-sticky-note" style="font-size: 48px; color: #bdc3c7; margin-bottom: 15px;"></i>
                        <p style="color: #7f8c8d;">Нет заметок</p>
                        <button class="btn btn-primary" onclick="addNote({{ student.id }})">
                            <i class="fas fa-plus"></i> Добавить первую заметку
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Переключение вкладок
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');

                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });

                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Показать/скрыть детали абонемента
        function showWeaponDetails(subscriptionId) {
            const details = document.getElementById(`details-${subscriptionId}`);
            if (details) {
                details.style.display = 'block';
            }
        }

        function hideWeaponDetails(subscriptionId) {
            const details = document.getElementById(`details-${subscriptionId}`);
            if (details) {
                details.style.display = 'none';
            }
        }

        // AJAX функции
        function addSubscription(studentId) {
            window.location.href = `/subscriptions/add/?student=${studentId}`;
        }

        function addPayment(studentId) {
            window.location.href = `/payments/add/?student=${studentId}`;
        }

        function addToGroup(studentId) {
            window.location.href = `/groups/add-student/?student=${studentId}`;
        }

        function addNote(studentId) {
            const note = prompt('Введите заметку:');
            if (note) {
                fetch(`/api/students/${studentId}/notes/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ content: note })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            }
        }

        function sendEmail(email) {
            if (email) {
                window.location.href = `mailto:${email}`;
            } else {
                alert('Email не указан');
            }
        }

        function viewSubscription(subscriptionId) {
            window.location.href = `/subscriptions/${subscriptionId}/`;
        }

        function extendLocker(lockerRentalId) {
    window.location.href = `/locker-rentals/${lockerRentalId}/extend/`;
}

        function manageKey(lockerRentalId, keyIssued) {
            const action = keyIssued ? 'return' : 'issue';
            fetch(`/api/locker-rentals/${lockerRentalId}/key/${action}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }

        function changePhoto(studentId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('photo', file);

                    fetch(`/api/students/${studentId}/upload-photo/`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector('.avatar').src = data.photo_url + '?t=' + new Date().getTime();
                        }
                    });
                }
            };
            input.click();
        }

        // Вспомогательная функция для получения CSRF токена
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Автоматически показываем детали при загрузке, если абонемент один
        document.addEventListener('DOMContentLoaded', function() {
            const subscriptions = document.querySelectorAll('.weapon-card');
            if (subscriptions.length === 1) {
                const subscriptionId = subscriptions[0].getAttribute('data-weapon');
                showWeaponDetails(subscriptionId);
            }
        });
    </script>
{% endblock %}