{% extends 'header_menu.html' %}

{% block title %}CRM — Профиль сотрудника{% endblock %}

{% block content %}
<!-- Основная карточка -->
<div class="student-card">
    <!-- Левая часть с аватаром -->
    <div class="student-left">
        <div class="avatar-container">
            <div class="avatar-img" id="avatar-img"></div>
            <div class="avatar-edit" onclick="document.getElementById('avatar-upload').click()">
                <i class="fas fa-camera"></i>
            </div>
            <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
        </div>

        <div class="student-name" id="full-name">Загрузка...</div>
        <div class="student-id">ID: <span id="user-id">—</span></div>
        <div class="status-badge status-active">
            <i class="fas fa-check-circle"></i> Активный
        </div>

        <div class="quick-info">
            <div class="info-item">
                <i class="fas fa-envelope"></i>
                <span id="email-display">—</span>
            </div>
            <div class="info-item">
                <i class="fas fa-phone"></i>
                <span id="phone-display">—</span>
            </div>
            <div class="info-item">
                <i class="fas fa-user-tag"></i>
                <span id="role-display">—</span>
            </div>
            <div class="info-item">
                <i class="fas fa-calendar-alt"></i>
                <span id="join-date-display">—</span>
            </div>
        </div>
    </div>

    <!-- Правая часть с формой -->
    <div class="student-right">
        <form id="profile-form" hx-put="/api/profile/" hx-target="#message" hx-swap="innerHTML">
            <div class="form-grid">
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="email" name="email" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label for="first_name"><i class="fas fa-user"></i> Имя</label>
                    <input type="text" id="first_name" name="first_name" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label for="last_name"><i class="fas fa-user"></i> Фамилия</label>
                    <input type="text" id="last_name" name="last_name" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label for="phone"><i class="fas fa-phone"></i> Телефон</label>
                    <input type="tel" id="phone" name="phone" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label for="birth_date"><i class="fas fa-birthday-cake"></i> Дата рождения</label>
                    <input type="text" id="birth_date" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label for="join_date"><i class="fas fa-calendar-plus"></i> Дата вступления</label>
                    <input type="text" id="join_date" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label for="emergency_contact"><i class="fas fa-exclamation-triangle"></i> Экстренный контакт</label>
                    <input type="text" id="emergency_contact" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label for="address"><i class="fas fa-map-marker-alt"></i> Адрес</label>
                    <input type="text" id="address" class="form-control" readonly>
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="editMode()">
                    <i class="fas fa-edit"></i> Редактировать
                </button>
                <button type="button" class="btn btn-primary" onclick="saveChanges()">
                    <i class="fas fa-save"></i> Сохранить
                </button>
                <button type="button" class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </form>

        <div id="message" class="message"></div>
    </div>
</div>

<!-- История изменений -->
<div class="logs-section">
    <h2><i class="fas fa-history"></i> История изменений</h2>
    <ul class="log-list" id="logs-list">
        <li class="log-item">
            <div class="log-action">Загрузка истории изменений...</div>
            <div class="log-time">—</div>
        </li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Управление меню (эти функции уже в base.html, можно удалить)
    function fillProfile(data) {
        // Основная информация в левой панели
        const fullName = `${data.first_name || ''} ${data.last_name || ''}`.trim() || 'Участник';
        document.getElementById('full-name').textContent = fullName;
        document.getElementById('user-id').textContent = data.id || '—';
        document.getElementById('email-display').textContent = data.email || '—';
        document.getElementById('phone-display').textContent = data.phone || '—';
        document.getElementById('role-display').textContent = data.role || '—';
        document.getElementById('join-date-display').textContent = data.join_date || '—';

        // Информация в шапке (это теперь в base.html)
        document.getElementById('header-user-name').textContent = fullName;
        document.getElementById('header-user-role').textContent = data.role || 'Сотрудник';

        // Инициалы для аватара в шапке
        const initials = getInitials(fullName);
        document.getElementById('user-avatar').innerHTML = initials || '<i class="fas fa-user"></i>';

        // Форма
        document.getElementById('email').value = data.email || '';
        document.getElementById('first_name').value = data.first_name || '';
        document.getElementById('last_name').value = data.last_name || '';
        document.getElementById('phone').value = data.phone || '';
        document.getElementById('birth_date').value = data.birth_date || '';
        document.getElementById('join_date').value = data.join_date || '';
        document.getElementById('emergency_contact').value = data.emergency_contact || '';
        document.getElementById('address').value = data.address || '';

        // Аватарка
        if (data.avatar_url) {
            document.getElementById('avatar-img').style.backgroundImage = `url(${data.avatar_url})`;
        }
    }

    // Функция для получения инициалов
    function getInitials(name) {
        return name.split(' ')
            .map(word => word.charAt(0))
            .join('')
            .toUpperCase()
            .slice(0, 2);
    }

    // Остальные функции оставляем без изменений
    document.addEventListener('DOMContentLoaded', function () {
        const token = localStorage.getItem('access_token');
        console.log('Token from localStorage:', token);

        if (!token) {
            console.error('No token! Redirecting to login...');
            window.location.href = '/login/';
            return;
        }

        // Показываем что происходит
        document.getElementById('full-name').textContent = 'Загрузка данных...';

        // Делаем простой fetch запрос
        fetch('/api/me/', {
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);

            if (response.status === 404) {
                console.error('404 - Endpoint not found');
                document.getElementById('message').innerHTML =
                    '<div class="error">Ошибка 404: Endpoint /api/me/ не найден</div>';
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }

            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);

            if (data) {
                fillProfile(data);

                // Показываем успех
                document.getElementById('message').innerHTML =
                    '<div class="success"><i class="fas fa-check-circle"></i> Данные загружены успешно!</div>';
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            document.getElementById('message').innerHTML =
                `<div class="error"><i class="fas fa-exclamation-circle"></i> Ошибка: ${error.message}</div>`;

            // Заполняем тестовыми данными при ошибке
            fillProfile({
                id: 1,
                email: 'test@example.com',
                first_name: 'Тестовый',
                last_name: 'Пользователь',
                role: 'Администратор',
                phone: '+7 (999) 111-22-33',
                birth_date: '15.05.1985',
                join_date: '01.09.2023',
                emergency_contact: 'Техподдержка',
                address: 'Офис 101'
            });
        });

        // Загружаем историю изменений
        loadChangeLogs(token);
    });

    function editMode() {
        const inputs = document.querySelectorAll('#profile-form .form-control');
        inputs.forEach(input => {
            input.removeAttribute('readonly');
            input.style.background = '#fff';
            input.style.borderColor = '#3498db';
        });

        document.getElementById('message').innerHTML =
            '<div class="success"><i class="fas fa-edit"></i> Режим редактирования включен</div>';
    }

    function saveChanges() {
        const token = localStorage.getItem('access_token');
        const form = document.getElementById('profile-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        fetch('/api/profile/', {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('message').innerHTML =
                '<div class="success"><i class="fas fa-check-circle"></i> Изменения сохранены успешно!</div>';

            // Блокируем поля обратно
            const inputs = document.querySelectorAll('#profile-form .form-control');
            inputs.forEach(input => {
                input.setAttribute('readonly', true);
                input.style.background = '#f0f0f0';
                input.style.borderColor = '#ddd';
            });

            // Обновляем отображение
            fillProfile(data);
        })
        .catch(error => {
            document.getElementById('message').innerHTML =
                `<div class="error"><i class="fas fa-exclamation-circle"></i> Ошибка сохранения: ${error.message}</div>`;
        });
    }

    function loadChangeLogs(token) {
        fetch('/api/change-logs/', {
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const logsList = document.getElementById('logs-list');
            logsList.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(log => {
                    const li = document.createElement('li');
                    li.className = 'log-item';
                    li.innerHTML = `
                        <div class="log-action">${log.action_type || 'Изменение'} — ${log.table_name || 'Профиль'}</div>
                        <div class="log-time">${new Date(log.change_time).toLocaleString('ru-RU')}</div>
                    `;
                    logsList.appendChild(li);
                });
            } else {
                logsList.innerHTML = `
                    <li class="log-item">
                        <div class="log-action">История изменений отсутствует</div>
                        <div class="log-time">—</div>
                    </li>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading change logs:', error);
        });
    }

    // Обработка загрузки аватарки
    document.getElementById('avatar-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatar-img').style.backgroundImage = `url(${e.target.result})`;
                document.getElementById('message').innerHTML =
                    '<div class="success"><i class="fas fa-check-circle"></i> Фото обновлено (локально)</div>';
            };
            reader.readAsDataURL(file);
        }
    });
</script>
{% endblock %}